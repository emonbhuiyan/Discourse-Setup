name: Secure Deployment

on:
  workflow_dispatch:  # Manual trigger only

env:
  # From GitHub Secrets
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  WEBAPP_ADMIN_USERNAME: ${{ secrets.WEBAPP_ADMIN_USERNAME }}
  WEBAPP_ADMIN_PASSWORD: ${{ secrets.WEBAPP_ADMIN_PASSWORD }}
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  GTM_ID: ${{ secrets.GTM_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Initialize empty config
        run: |
          cat << EOF > config.py
          # Web-configured values
          API_KEY = ""
          ADMIN_USERNAME = ""
          OCCUPATION = ""
          CATEGORIES = {}
          topics = []

          # Auto-generated
          FORMATTED_OCCUPATION = ""
          SITE_URL = ""
          DISCOURSE_URL = ""
          SITE_TITLE = ""
          SITE_DESCRIPTION = ""

          # Google Analytics (from env)
          import os
          GOOGLE_CLIENT_ID = os.getenv('GOOGLE_CLIENT_ID', '')
          GOOGLE_CLIENT_SECRET = os.getenv('GOOGLE_CLIENT_SECRET', '')
          GTM_ID = os.getenv('GTM_ID', '')
          EOF

      - name: Start Application
        run: python app.py